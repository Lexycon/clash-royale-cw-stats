
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta content="utf-8" http-equiv="encoding">
        <title>Clash Royale Clanwar Statistics</title>
        <meta name="description" content="">
        <meta name="author" content="">
        <meta name="keywords" content="">
        <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
        <link href="build.css" rel="stylesheet">
        <script src="https://d3js.org/d3.v5.min.js"; charset="utf-8"></script>
        <script>

            d3.csv("cr-cw-list.csv") 
            .then(function(data) {
                function getRowType(item) {
                    // item exists not in column[1] -> row 0 (Name, Wins, ...)
                    if (columns[1].indexOf(item) == -1) return 0;
                    // item exists not in column[0] -> row 1 (#1, #2, ...)
                    else if (columns[0].indexOf(item) == -1) return 1;
                    else return -1;
                }

                function getColSpan(name) {
                    switch(name) {
                        case 'Name': return 4;
                        case 'Wins': case 'Cards': return 3;
                        default: return 1;
                    }
                }
                function deleteUnwantedProps(obj, arr) {
                    Object.keys(obj).forEach(function(item){
                        found = false;
                        for (var i= 0; i < arr.length; i++)
                        if (item == arr[i]) found = true;
                        if (!found) delete obj[item];
                    });
                }

                // the columns you'd like to display
                var columns = [2];
                columns[0] = ["Name", "Wins", "Cards"];
                columns[1] = ["#1", "#2", "#3", "#4", "#5", "#6", "#7", "#8", "#9", "#10"];

                var table = d3.select("#container").append("table"),
                    thead = table.append("thead"),
                    tbody = table.append("tbody");


                // split each row from the data object in two (two "header" rows)
                // some math calcs
                var sumWins = 0;
                var sumBattles = 0;
                var avgCards = 0;

                for (var i = data.length -1; i >= 0; i--) {
                    sumWins += Number(data[i]['Wins']);
                    sumBattles += Number(data[i]['Battles']);
                    avgCards += Number(data[i]['Cards']);

                    data[2*i] = data[i]
                    data[2*i+1] = Object.assign({}, data[i]); 

                    winRate = Math.round(data[2*i]['Wins'] / data[2*i]['Battles'] * 100 * 100) / 100;
                    data[2*i]['Wins'] += "/" + data[2*i]['Battles'] + " (" + (isNaN(winRate) ? 0 : winRate)  + "%)";

                    deleteUnwantedProps(data[2*i], columns[0]);
                    deleteUnwantedProps(data[2*i+1], columns[1]);
                }
                
                avgCards = Math.round(avgCards / (data.length / 2));

                // append the 1st header row
                thead.append("tr").selectAll("th").data(columns[0]).enter().append("th")
                    .text(function(column) { 
                        switch (column) {
                            case "Wins":
                                return column + " (Ø " + Math.round(sumWins / sumBattles * 100 * 100) / 100 + "%)";
                            case "Cards":
                                return column + " (Ø " + avgCards + ")";
                        }
                        return column; })
                    .attr("colspan", function(column) { return getColSpan(column) });                 

                // append the 2nd header row
                thead.append("tr").selectAll("th").data(columns[1]).enter().append("th").text(function(column) { return column; });

                // create a row for each object in the data
                var rows = tbody.selectAll("tr")
                    .data(data)
                    .enter()
                    .append("tr");

                // create a cell in each row for each column
                var cells = rows.selectAll("td")
                    .data(function(row) {
                        return columns[getRowType(Object.keys(row)[0])].map(function(column) {
                            return {column: column, value: row[column]};                       
                        }); 
                    })
                    .enter()
                    .append("td")
                    .attr("colspan", function(d) { return getColSpan(d.column) })
                    .attr("class", function(d) {
                        if(getRowType(d.column) == 1) {
                            columnValue = d.value.split(";");
                            // not participated
                            if (columnValue[1] === "" && columnValue[2] === "") {
                                return "grey";
                            // battles == 0 -> blue
                            } else if (columnValue[2] == 0) {
                                return "blue";
                            // battles > 0 and wins > 0 and wins != battles (e.g. 1/2) -> orange
                            } else if (columnValue[2] > 1 && columnValue[1] > 0 && columnValue[1] != columnValue[2]) {
                                return "orange";
                            // battles > 0 and wins != battles -> red
                            } else if (columnValue[2] > 0 && columnValue[1] != columnValue[2]) {
                                return "red";
                            // battles > 0 and wins == battles -> green
                            } else if (columnValue[2] > 0 && columnValue[1] == columnValue[2]) {
                                return "green";
                            }
                        } else if (d.column == "Name") {
                            return "name";
                        }
                    })
                    .text(function(d) {
                        if(getRowType(d.column) == 1) {
                            columnValue = d.value.split(";");
                            if (columnValue[0] == "") return "-";
                            return columnValue[0] + " (" + columnValue[1] + "/" + columnValue[2] +")";
                        } else {
                            return d.value;
                        }
                    });
            });
        </script>

   
    </head>

<body>
    <div id="container"></div>              
</body>
</html>